{% extends "base.html" %}

{% block title %}Dashboard - PaperHub{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar enhanced-sidebar">
        <div class="sidebar-section">
            <a href="{{ url_for('main.upload') }}" class="btn btn-block btn-primary" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i> Add Papers
            </a>
            <div class="sidebar-group">
                <div class="sidebar-title">
                    <span>FOLDERS</span>
                    <i class="fas fa-plus-circle sidebar-action-icon" onclick="showCreateForm('folder')"></i>
                </div>
                <form id="folderForm" class="create-form" method="POST" action="{{ url_for('main.create_folder') }}">
                    <input type="text" name="name" placeholder="New folder name..." required>
                    <button type="submit">Add</button>
                </form>
                {% for folder in folders %}
                <div class="sidebar-folder">
                    <i class="fas fa-folder"></i> {{ folder.name }} <span class="count">{{ folder.papers|length }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="sidebar-group">
                <div class="sidebar-title">
                    <span>LABELS</span>
                    <i class="fas fa-plus-circle sidebar-action-icon" onclick="showCreateForm('label')"></i>
                </div>
                <form id="labelForm" class="create-form" method="POST" action="{{ url_for('main.create_category') }}">
                    <input type="text" name="name" placeholder="New label name..." required>
                    <input type="color" name="color" value="#3498db">
                    <button type="submit">Add</button>
                </form>
                {% for category in categories %}
                <div class="sidebar-label">
                    <span class="label-color" {% if category.color %}style="background-color: {{ category.color }};"{% endif %}></span>
                    {{ category.name }}
                    <span class="count">{{ category.papers|length }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- Main Content -->
    <div class="main-content enhanced-main-content">
        <div class="content-header enhanced-content-header">
            <input type="text" id="searchInput" placeholder="Search papers..." class="search-input enhanced-search-input" onkeyup="searchPapers()">
            <span class="search-label">Search: <span id="searchTermDisplay"></span></span>
        </div>
        <div class="papers-list enhanced-papers-list" id="papersList">
            {% for paper in papers %}
            <div class="paper-row enhanced-paper-row" data-title="{{ paper.title }}" data-authors="{{ paper.authors }}" data-abstract="{{ paper.abstract }}">
                <div class="paper-info">
                    <div class="paper-title-authors">
                        <a href="{{ url_for('main.view_paper', paper_id=paper.id) }}" class="paper-title-link" target="_blank">
                            <span class="highlightable">{{ paper.title }}</span>
                        </a>
                        <div class="paper-authors highlightable">
                            {{ paper.authors }}
                        </div>
                        <div class="paper-abstract highlightable">
                            {{ paper.abstract[:500] }}...
                        </div>
                    </div>
                    <div class="paper-meta">
                        <span class="paper-journal">{{ paper.journal or 'Journal Article' }}</span>
                        <span class="paper-year">{{ paper.uploaded_at.year }}</span>
                        {% if paper.category %}
                        <span class="badge enhanced-badge" {% if paper.category.color %}style="background-color: {{ paper.category.color }};"{% endif %}>{{ paper.category.name }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="paper-actions enhanced-paper-actions">
                    <a href="{{ url_for('main.view_paper', paper_id=paper.id) }}" target="_blank" class="btn-icon" title="View PDF"><i class="fas fa-eye"></i></a>
                    <button class="btn-icon" title="Edit" onclick="openModal('edit-modal-{{ paper.id }}')"><i class="fas fa-edit"></i></button>
                    <form method="POST" action="{{ url_for('main.delete_paper', paper_id=paper.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this paper?');">
                        <button type="submit" class="btn-icon danger" title="Delete"><i class="fas fa-trash"></i></button>
                    </form>
                </div>
            </div>

            <!-- The Modal -->
            <div id="edit-modal-{{ paper.id }}" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('edit-modal-{{ paper.id }}')">&times;</span>
                    <h3>Edit Paper</h3>
                    <p class="modal-paper-title">{{ paper.title }}</p>
                    <form method="POST" action="{{ url_for('main.update_paper', paper_id=paper.id) }}" class="modal-form">
                        <div class="form-group">
                            <label>Folder:</label>
                            <select name="folder_id" class="form-control">
                                <option value="">(No Folder)</option>
                                {% for folder in folders %}
                                <option value="{{ folder.id }}" {% if paper.folder_id == folder.id %}selected{% endif %}>{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Label:</label>
                            <select name="category_id" class="form-control">
                                <option value="">(No Label)</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if paper.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-file-pdf fa-3x"></i>
                <h3>No papers yet</h3>
                <p>Upload your first research paper to get started!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function highlightTerm(element, term) {
    if (!term) return;
    const regex = new RegExp(`(${term})`, 'gi');
    element.innerHTML = element.textContent.replace(regex, '<mark>$1</mark>');
}

function searchPapers() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    document.getElementById('searchTermDisplay').textContent = searchTerm;
    const rows = document.querySelectorAll('.enhanced-paper-row');
    rows.forEach(row => {
        const title = row.dataset.title.toLowerCase();
        const authors = row.dataset.authors.toLowerCase();
        const abstract = row.dataset.abstract.toLowerCase();
        let match = false;
        if (searchTerm && (title.includes(searchTerm) || authors.includes(searchTerm) || abstract.includes(searchTerm))) {
            match = true;
        } else if (!searchTerm) {
            match = true;
        }
        row.style.display = match ? '' : 'none';
        // Highlight
        row.querySelectorAll('.highlightable').forEach(el => {
            el.innerHTML = el.textContent; // Reset
            if (searchTerm) highlightTerm(el, searchTerm);
        });
    });
}

function showCreateForm(type) {
    const form = document.getElementById(type + 'Form');
    form.style.display = form.style.display === 'block' ? 'none' : 'block';
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Close modal if user clicks outside of it
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %} 